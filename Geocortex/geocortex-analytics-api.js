/**
 * Package: @geocortex/analytics-app-api - Javascript API for Geocortex Analytics.
 * @version v0.1.78
 * @copyright Copyright Â© 2018 Latitude Geographics Group Ltd. All rights reserved.
 */
var geocortex;!function(t){!function(t){!function(t){!function(t){!function(t){var e=function(){function t(){this._buildDataMap()}return t.prototype.toQueryString=function(){return this._mapDataToQueryString()},t.prototype._mapDataToQueryString=function(){if(null==this._datamap)return"";for(var e=this._buildQueryStringProperty(t.dataTypeProperty,this._getDataMapTypeId().toString()),n=0,o=this._datamap.length;n<o;n++){var r=this._datamap[n],a=this[r.property];if(void 0!==a&&null!=a&&""!==a){if(null!=r.toFormattedString){if(void 0===(a=r.toFormattedString(a))||null==a||""===a)continue}else if("boolean"==typeof a){var i=a;a=!0===i?1:0}e+=(""!=e?"&":"")+this._buildQueryStringProperty(r.abbrv,a.toString())}}return e},t.prototype._buildQueryStringProperty=function(t,e){return encodeURIComponent(t)+"="+encodeURIComponent(e)},t.dataTypeProperty="t",t}();t.Data=e}(t.base||(t.base={}))}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){var e=function(){function t(){}return t.prototype.addDataToBeSent=function(t){throw"Not implemented"},t.prototype.forceSendPendingData=function(){throw"Not implemented"},t}();t.ImplRelay=e}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){!function(t){t[t.App=0]="App",t[t.Session=1]="Session",t[t.User=2]="User",t[t.Browser=3]="Browser",t[t.LayerState=4]="LayerState",t[t.PortalUser=5]="PortalUser"}(t.DataTypes||(t.DataTypes={}));t.DataTypes}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(e){function n(t,n,o,r){e.call(this),this.username=t,this.email=n,this.fullName=o,this.portalUrl=r}return __extends(n,e),n.prototype._getDataMapTypeId=function(){return t.DataTypes.PortalUser},n.prototype._buildDataMap=function(){this._datamap=[{abbrv:"pun",property:"username"},{abbrv:"pem",property:"email"},{abbrv:"pfn",property:"fullName"},{abbrv:"ppu",property:"portalUrl"}]},n}(t.base.Data);t.PortalUser=e}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(e){var n=function(){function e(){}return e.portalUserLogin=function(e){if(null==e||null==e.username||null==e.email||null==e.fullName||null==e.portalUrl)return void console.log("Portal user must have a username, email, fullName, and portalUrl");var n=new t.data.PortalUser(e.username,e.email,e.fullName,e.portalUrl);gcxAnalyticsRelay.addDataToBeSent(n),gcxAnalyticsRelay.forceSendPendingData()},e}();e.AppEvent=n}(t.appevents||(t.appevents={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(e){function n(t){e.call(this),this.appId=t}return __extends(n,e),n.prototype._getDataMapTypeId=function(){return t.DataTypes.App},n.prototype._buildDataMap=function(){this._datamap=[{abbrv:"aa",property:"appId"}]},n}(t.base.Data);t.App=e}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.init=function(){this.locale=this._locale(),this.screenDimensions=this._screenDimensions(),this.browserDimensions=this._browserDimensions()},n.prototype._getDataMapTypeId=function(){return t.DataTypes.Browser},n.prototype._buildDataMap=function(){var t=this;this._datamap=[{abbrv:"bl",property:"locale"},{abbrv:"bsd",property:"screenDimensions",toFormattedString:function(e){return t._dimensionsToString(e)}},{abbrv:"bbd",property:"browserDimensions",toFormattedString:function(e){return t._dimensionsToString(e)}}]},n.prototype._locale=function(){return navigator.language?navigator.language:navigator.userLanguage?navigator.userLanguage:navigator.browserLanguage?navigator.browserLanguage:"unknown"},n.prototype._screenDimensions=function(){return{width:screen.width,height:screen.height}},n.prototype._browserDimensions=function(){var t=0,e=0;return"number"==typeof window.innerWidth?(t=window.innerWidth,e=window.innerHeight):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?(t=document.documentElement.clientWidth,e=document.documentElement.clientHeight):document.body&&(document.body.clientWidth||document.body.clientHeight)&&(t=document.body.clientWidth,e=document.body.clientHeight),{width:t,height:e}},n.prototype._dimensionsToString=function(t){return t.width.toString()+"x"+t.height.toString()},n}(t.base.Data);t.Browser=e}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(){function t(){}return t.generateUid=function(){var t=(new Date).getTime();return"xxxxxxxxxxxxxxxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:7&n|8).toString(16)})},t}();t.UniqueIds=e}(t.utilities||(t.utilities={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(e){var n=function(n){function o(){n.call(this),this.sessionId=t.utilities.UniqueIds.generateUid(),this.sessionStart=new Date,this._lastSessionInteraction=new Date}return __extends(o,n),o.prototype.init=function(){var t=this;document.addEventListener?document.addEventListener("click",function(){return t.incrementSessionDuration()},!1):document.attachEvent&&document.attachEvent("onclick",function(){return t.incrementSessionDuration()}),this.sessionHost=location.hostname},o.prototype.incrementSessionDuration=function(){this._lastSessionInteraction=new Date},o.prototype.getSessionDuration=function(){return+this._lastSessionInteraction-+this.sessionStart},o.prototype._getDataMapTypeId=function(){return e.DataTypes.Session},o.prototype._buildDataMap=function(){var t=this;this._datamap=[{abbrv:"ss",property:"sessionId"},{abbrv:"ssd",property:"sessionStart",toFormattedString:function(e){return t.getSessionDuration().toString()}},{abbrv:"ssh",property:"sessionHost"}]},o}(e.base.Data);e.Session=n}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(){function t(){}return t.isStorageAvailable=function(){return!1},t.getItem=function(t){throw"Not implemented"},t.setItem=function(t,e){throw"Not implemented"},t.removeItem=function(t){throw"Not implemented"},t}();t.Storage=e}(t.storage||(t.storage={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.isStorageAvailable=function(){return null==this._enabled&&(this._enabled=this._isLocalStorageAvailable()),this._enabled},e.getItem=function(t){if(this.isStorageAvailable())return localStorage.getItem(t)},e.setItem=function(t,e){this.isStorageAvailable()&&localStorage.setItem(t,e)},e.removeItem=function(t){this.isStorageAvailable()&&localStorage.removeItem(t)},e._isLocalStorageAvailable=function(){if(null==window.localStorage)return!1;var t="gcxAnalytics-testLocalStorage";try{return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}},e}(t.Storage);t.LocalStorage=e}(t.storage||(t.storage={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.isStorageAvailable=function(){return null==this._enabled&&(this._enabled=this._getCookieSupport()),this._enabled},e.setItem=function(t,e,n){if(void 0===n&&(n=0),this.isStorageAvailable()){var o="";if(0!==n){var r=new Date;r.setTime(r.getTime()+24*n*60*60*1e3),o="; expires="+r.toUTCString()}else o="; expires=Tue, 19-Jan-2038 03:14:08 GMT";document.cookie=t+"="+e+o+"; path=/"}},e.getItem=function(t){if(this.isStorageAvailable()){for(var e=t+"=",n=document.cookie.split(";"),o=0;o<n.length;o++){for(var r=n[o];" "==r.charAt(0);)r=r.substring(1,r.length);if(0==r.indexOf(e))return r.substring(e.length,r.length)}return null}},e.removeItem=function(t){this.isStorageAvailable()&&this.setItem(t,"",-1)},e.disableStorage=function(){this._enabled=!1},e._getCookieSupport=function(){var t=!0;do{var e="gcxAnalytics-cookieTest="+Math.floor(1e8*Math.random());if(document.cookie=t?e+";expires=Tue, 19-Jan-2038 03:14:08 GMT":e,-1!==document.cookie.indexOf(e))return document.cookie=e+";expires=Sat, 01-Jan-2000 00:00:00 GMT",t}while(!(t=!t));return!1},e}(t.Storage);t.Cookie=e}(t.storage||(t.storage={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(e){var n=function(n){function o(){n.apply(this,arguments),this._storageKey="geoAnalytics-workstationId"}return __extends(o,n),o.prototype.init=function(){var e=t.storage.Storage;if(t.storage.LocalStorage.isStorageAvailable()?e=t.storage.LocalStorage:t.storage.Cookie.isStorageAvailable()&&(e=t.storage.Cookie),e.isStorageAvailable()){var n=e.getItem(this._storageKey);null!=n&&""!=n||(n=t.utilities.UniqueIds.generateUid(),e.setItem(this._storageKey,n)),this.workstationId=n}else this.workstationId=t.utilities.UniqueIds.generateUid()},o.prototype._getDataMapTypeId=function(){return e.DataTypes.User},o.prototype._buildDataMap=function(){this._datamap=[{abbrv:"uw",property:"workstationId"}]},o}(e.base.Data);e.User=n}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(e){function n(t,n,o){e.call(this),this.layerId=t,this.layerType=n,this.layerUrl=o,this.timestamp=new Date}return __extends(n,e),n.prototype._getDataMapTypeId=function(){return t.DataTypes.LayerState},n.prototype._buildDataMap=function(){var t=this;this._datamap=[{abbrv:"lslu",property:"layerUrl"},{abbrv:"lslt",property:"layerType"},{abbrv:"lsli",property:"layerId"},{abbrv:"lsln",property:"layerName"},{abbrv:"lsv",property:"visible"},{abbrv:"lsem",property:"exceptionMessage"},{abbrv:"lsiis",property:"isInitialState"},{abbrv:"lsil",property:"isLoaded"},{abbrv:"lsvsln",property:"subLayerIdsVisibilityTurnedOn",toFormattedString:function(e){return t.subLayerIdsVisibilityTurnedOn.toString()}},{abbrv:"lsvslf",property:"subLayerIdsVisibilityTurnedOff",toFormattedString:function(e){return t.subLayerIdsVisibilityTurnedOff.toString()}},{abbrv:"lst",property:"timestamp",toFormattedString:function(e){return t.timestamp.getTime().toString()}}]},n}(t.base.Data);t.LayerState=e}(t.data||(t.data={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={})),Array.prototype.filter||(Array.prototype.filter=function(t,e){if(null===this)throw new TypeError("The array is null or undefined");var n=Object(this),o=n.length>>>0;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(var r=[],a=0;a<o;a++)if(a in n){var i=n[a];t.call(e,i,a,n)&&r.push(i)}return r}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){if(null==this)throw new TypeError("The array is null or undefined");var n=Object(this),o=n.length>>>0;if(0===o)return-1;var r=0|e;if(r>=o)return-1;for(var a=Math.max(r>=0?r:o-Math.abs(r),0);a<o;){if(a in n&&n[a]===t)return a;a++}return-1}),Array.prototype.map||(Array.prototype.map=function(t,e){if(null==this)throw new TypeError("The array is null or undefined");var n=Object(this),o=n.length>>>0;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(var r=new Array(o),a=0;a<o;)a in n&&(r[a]=t.call(e,n[a],a,n)),a++;return r});var geocortex;!function(t){!function(t){!function(t){!function(t){var e=function(){function t(){}return t.remove=function(t,e){var n=t.indexOf(e);n>-1&&t.splice(n,1)},t.except=function(t,e){return t.filter(function(t){return-1==e.indexOf(t)})},t}();t.ArrayHelper=e}(t.utilities||(t.utilities={}))}(t.core||(t.core={}))}(t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));
var geocortex;!function(e){!function(t){!function(r){var a=function(){function r(e){var t=this;this._layerEventHandles=[],this._visibleSubLayerStates=[],this.map=e,e.loaded?this._startMonitoringMap():this._mapLoadEventHandle=e.on("load",function(){return t._startMonitoringMap()}),this._mapLoadEventHandle=e.on("unload",function(){return t.shutdown()}),this._mapExtentChangedHandle=e.on("extent-change",function(){setTimeout(function(){return gcxAnalyticsData.session.incrementSessionDuration()},0)}),this._layerAddEventHandle=e.on("layer-add",function(e){setTimeout(function(){return t._onLayerAddedToMap(e)},0)}),this._layerRemoveEventHandle=e.on("layer-remove",function(e){setTimeout(function(){return t._onLayerRemovedFromMap(e)},0)})}return r.prototype.shutdown=function(){this._removeAllEventListeners()},r.prototype._startMonitoringMap=function(){var e=this;if(void 0!==this.map.layerIds)for(var t=this.map.layerIds,r=this,a=0;a<t.length;a++)!function(a){var i=r.map.getLayer(t[a]);setTimeout(function(){e._startMonitoringLayer(i)},0)}(a);if(void 0!==this.map.graphicsLayerIds)for(var i=this.map.graphicsLayerIds,n=this,a=0;a<i.length;a++)!function(t){var r=n.map.getLayer(i[t]);setTimeout(function(){e._startMonitoringLayer(r)},0)}(a);if(void 0!==this.map.basemapLayerIds)for(var s=this.map.basemapLayerIds,o=this,a=0;a<s.length;a++)!function(t){var r=o.map.getLayer(s[t]);setTimeout(function(){e._startMonitoringLayer(r)},0)}(a)},r.prototype._startMonitoringLayer=function(e){this._addEventListenersToLayer(e);var t=r._esriLayerToParsedLayerInfo(e);t.isInitialState=!0,t.visible=e.visible,t.subLayerIdsVisibilityTurnedOn=r._getSubLayersWithDefaultVisibility(e,!0),t.subLayerIdsVisibilityTurnedOff=r._getSubLayersWithDefaultVisibility(e,!1),this._updateSubLayerVisibilityState(t.layerId,t.subLayerIdsVisibilityTurnedOn),gcxAnalyticsRelay.addDataToBeSent(t)},r._getSubLayersWithDefaultVisibility=function(e,t){if(void 0!==esri.layers.ArcGISDynamicMapServiceLayer&&e instanceof esri.layers.ArcGISDynamicMapServiceLayer){return e.layerInfos.filter(function(e){return e.defaultVisibility===t}).map(function(e){return e.id})}if(void 0!==esri.layers.ArcGISTiledMapServiceLayer&&e instanceof esri.layers.ArcGISTiledMapServiceLayer){return e.layerInfos.filter(function(e){return e.defaultVisibility===t}).map(function(e){return e.id})}return null},r.prototype._updateSubLayerVisibilityState=function(e,t){var r=this._getMatchingSubLayerVisibilityState(e);null!=r?r.visibleSubLayers=t:(r={layerId:e,visibleSubLayers:t},this._visibleSubLayerStates.push(r))},r.prototype._getMatchingSubLayerVisibilityState=function(e){for(var t=0;t<this._visibleSubLayerStates.length;t++)if(this._visibleSubLayerStates[t].layerId===e)return this._visibleSubLayerStates[t];return null},r.prototype._addEventListenersToLayer=function(e){var t=this,r=e.on("load",function(e){setTimeout(function(){return t._onLayerLoaded(e)},0)}),a=e.on("visibility-change",function(e){setTimeout(function(){return t._onLayerVisibilityChange(e)},0)}),i=e.on("error",function(e){setTimeout(function(){return t._onLayerErrorOccurred(e)},0)}),n=[r,a,i];if(void 0!==esri.layers.ArcGISDynamicMapServiceLayer&&e instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=e,o=s.on("visible-layers-change",function(e){setTimeout(function(){return t._onSubLayerVisibilityChange(e)},0)});n.push(o)}var l={layerId:e.id,eventHandles:n};this._layerEventHandles.push(l)},r.prototype._removeAllEventListeners=function(){null!=this._mapLoadEventHandle&&this._mapLoadEventHandle.remove(),null!=this._mapExtentChangedHandle&&this._mapExtentChangedHandle.remove(),null!=this._layerAddEventHandle&&this._layerAddEventHandle.remove(),null!=this._layerRemoveEventHandle&&this._layerRemoveEventHandle.remove();for(var e=0;e<this._layerEventHandles.length;e++)for(var t=0;t<this._layerEventHandles[e].eventHandles.length;t++)this._layerEventHandles[e].eventHandles[t].remove()},r.prototype._onLayerAddedToMap=function(e){this._startMonitoringLayer(e.layer)},r.prototype._onLayerRemovedFromMap=function(e){for(var r=0;r<this._layerEventHandles.length;r++){if(this._layerEventHandles[r].layerId===e.layer.id){for(var a=0;a<this._layerEventHandles[r].eventHandles.length;a++)this._layerEventHandles[r].eventHandles[a].remove();return void t.core.utilities.ArrayHelper.remove(this._layerEventHandles,this._layerEventHandles[r])}return}for(var r=0;r<this._visibleSubLayerStates.length;r++)if(this._visibleSubLayerStates[r].layerId===e.layer.id){t.core.utilities.ArrayHelper.remove(this._visibleSubLayerStates,this._visibleSubLayerStates[r]);break}},r.prototype._onLayerLoaded=function(e){var t=r._esriLayerToParsedLayerInfo(e.target);gcxAnalyticsRelay.addDataToBeSent(t)},r.prototype._onLayerVisibilityChange=function(e){var t=r._esriLayerToParsedLayerInfo(e.target);t.visible=e.visible,gcxAnalyticsRelay.addDataToBeSent(t)},r.prototype._onSubLayerVisibilityChange=function(e){var a=r._esriLayerToParsedLayerInfo(e.target),i=this._getMatchingSubLayerVisibilityState(a.layerId);null!=i?(a.subLayerIdsVisibilityTurnedOn=t.core.utilities.ArrayHelper.except(e.visibleLayers,i.visibleSubLayers),a.subLayerIdsVisibilityTurnedOff=t.core.utilities.ArrayHelper.except(i.visibleSubLayers,e.visibleLayers)):a.subLayerIdsVisibilityTurnedOn=e.visibleLayers,this._updateSubLayerVisibilityState(a.layerId,e.visibleLayers),gcxAnalyticsRelay.addDataToBeSent(a)},r.prototype._onLayerErrorOccurred=function(e){var t=r._esriLayerToParsedLayerInfo(e.target);t.exceptionMessage=e.error.message,gcxAnalyticsRelay.addDataToBeSent(t)},r._esriLayerToParsedLayerInfo=function(t){var a;if(void 0!==esri.layers)for(var i=0;i<r._arcGisLayerTypes.length;i++){var n=esri.layers[r._arcGisLayerTypes[i]];if(void 0!==n&&t instanceof n){a=r._arcGisLayerTypes[i];break}}if(void 0!==esri.virtualearth)for(var s=0;s<r._arcGisVirtualEarthLayerTypes.length;s++){var o=esri.virtualearth[r._arcGisVirtualEarthLayerTypes[s]];if(void 0!==o&&t instanceof o){a=r._arcGisVirtualEarthLayerTypes[s];break}}var l=new e.analytics.core.data.LayerState(t.id,a,t.url);return l.isLoaded=t.loaded,l},r._arcGisLayerTypes=["ArcGISDynamicMapServiceLayer","ArcGISImageServiceLayer","ArcGISImageServiceVectorLayer","ArcGISTiledMapServiceLayer","CSVLayer","DataAdapterFeatureLayer","FeatureLayer","GeoRSSLayer","KMLLayer","MapImageLayer","OpenStreetMapLayer","RasterLayer","StreamLayer","VectorTileLayer","WebTiledLayer","WFSLayer","WMSLayer","WMTSLayer"],r._arcGisVirtualEarthLayerTypes=["VETiledLayer"],r}();r.MapMonitor=a}(t.arcgis3xintegration||(t.arcgis3xintegration={}))}(e.analytics||(e.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(t){var r=function(){function t(e){var t=this;this.portal=e,void 0!==e.getPortalUser?this._startMonitoringPortal():this._portalLoadEventHandle=e.on("load",function(){return t._startMonitoringPortal()})}return t.prototype.shutdown=function(){this._removeAllEventListeners()},t.prototype._startMonitoringPortal=function(){var e=this.portal.getPortalUser();null!=e&&t.recordPortalUser(e)},t.prototype._removeAllEventListeners=function(){null!=this._portalLoadEventHandle&&this._portalLoadEventHandle.remove()},t.recordPortalUser=function(t){if(null!=t){var r;r=t.portal.isPortal||null==t.portal.urlKey?(t.portal.allSSL?"https://":"http://")+t.portal.portalHostname:"https://"+t.portal.urlKey.toLowerCase()+"."+t.portal.customBaseUrl,e.core.appevents.AppEvent.portalUserLogin({username:t.username,email:t.email,fullName:t.fullName,portalUrl:r})}},t}();t.PortalMonitor=r}(e.arcgis3xintegration||(e.arcgis3xintegration={}))}(e.analytics||(e.analytics={}))}(geocortex||(geocortex={}));
var geocortex;!function(e){!function(e){!function(t){var a=function(){function t(e,t){this._layerEventHandles=[],this._visibleSubLayerStates=[],this.map=e,this.view=t,this._startMonitoringMap(),null!=this.view&&(this._viewInteractionHandle=this.view.watch("interacting",function(e,t,a,r){gcxAnalyticsData.session.incrementSessionDuration()}))}return t.prototype.shutdown=function(){this._removeAllEventListeners()},t.prototype._startMonitoringMap=function(){var e=this;if(this._mapLayersChangeHandle=this.map.allLayers.on("change",function(t){setTimeout(function(){return e._onMapLayersChanged(t)},0)}),null!=this.map.layers){var t=this.map.layers;this._monitorLayers(t)}if(null!=this.map.basemap&&null!=this.map.basemap.baseLayers){var t=this.map.basemap.baseLayers;this._monitorLayers(t)}},t.prototype._monitorLayers=function(e){for(var t=this,a=0;a<e.length;a++)!function(a){var r=e.getItemAt(a);setTimeout(function(){return t._startMonitoringLayer(r)},0)}(a)},t.prototype._startMonitoringLayer=function(e){var t=this._esriLayerToParsedLayerInfo(e);if(null!=t){t.visible=e.visible,t.isInitialState=!0;var a=this._getSubLayerVisibilities(e);a&&(t.subLayerIdsVisibilityTurnedOn=a.visibleSubLayerIds,t.subLayerIdsVisibilityTurnedOff=a.invisibleSubLayerIds),this._updateSubLayerVisibilityState(t.layerId,t.subLayerIdsVisibilityTurnedOn),this._addEventListenersToLayer(e),gcxAnalyticsRelay.addDataToBeSent(t)}},t.prototype._getSubLayerVisibilities=function(e){if("esri.layers.MapImageLayer"===e.declaredClass){for(var t=e,a=[],r=[],i=0;i<t.allSublayers.length;i++){var n=t.allSublayers.getItemAt(i);!0===n.visible?a.push(n.id):r.push(n.id)}return{visibleSubLayerIds:a,invisibleSubLayerIds:r}}return null},t.prototype._updateSubLayerVisibilityState=function(e,t){var a=this._getMatchingSubLayerVisibilityState(e);null!=a?a.visibleSubLayers=t:(a={layerId:e,visibleSubLayers:t},this._visibleSubLayerStates.push(a))},t.prototype._getMatchingSubLayerVisibilityState=function(e){for(var t=0;t<this._visibleSubLayerStates.length;t++)if(this._visibleSubLayerStates[t].layerId===e)return this._visibleSubLayerStates[t];return null},t.prototype._addEventListenersToLayer=function(e){var t=this,a=e.watch("loaded",function(e,a,r,i){setTimeout(function(){return t._onLayerLoadOccurred(i)},0)}),r=e.watch("visible",function(e,a,r,i){setTimeout(function(){return t._onLayerVisibilityChange(e,i)},0)}),i=e.watch("loadError",function(e,a,r,i){setTimeout(function(){return t._onLayerErrorOccurred(e,i)},0)}),n=[a,r,i],s=[];if("esri.layers.MapImageLayer"===e.declaredClass){for(var l=e,o=0;o<l.allSublayers.length;o++){var y=l.allSublayers.getItemAt(o),u=this._addEventListenersToSubLayer(y);s.push(u)}var d=l.allSublayers.on("change",function(e){t._onSubLayersChanged(e)});n.push(d)}var v={layerId:e.id,eventHandles:n,subLayerEventHandles:s};this._layerEventHandles.push(v)},t.prototype._addEventListenersToSubLayer=function(e){var t=this,a=e.watch("visible",function(e,a,r,i){setTimeout(function(){return t._onSubLayerVisibilityChange(e,i)},0)});return{layerId:e.id.toString(),eventHandles:[a]}},t.prototype._removeAllEventListeners=function(){void 0!==this._mapLayersChangeHandle&&null!=this._mapLayersChangeHandle&&this._mapLayersChangeHandle.remove(),void 0!==this._viewInteractionHandle&&null!=this._viewInteractionHandle&&this._viewInteractionHandle.remove();for(var e=0;e<this._layerEventHandles.length;e++)for(var t=0;t<this._layerEventHandles[e].eventHandles.length;t++)this._layerEventHandles[e].eventHandles[t].remove()},t.prototype._onMapLayersChanged=function(t){for(var a=0;a<t.added.length;a++)this._startMonitoringLayer(t.added[a]);for(var r=0;r<t.removed.length;r++){for(var i=0;i<this._layerEventHandles.length;i++)if(this._layerEventHandles[i].layerId===t.removed[r].id){for(var n=0;n<this._layerEventHandles[i].eventHandles.length;n++)this._layerEventHandles[i].eventHandles[n].remove();return void e.core.utilities.ArrayHelper.remove(this._layerEventHandles,this._layerEventHandles[i])}for(var i=0;i<this._visibleSubLayerStates.length;i++)if(this._visibleSubLayerStates[i].layerId===t.removed[r].id){e.core.utilities.ArrayHelper.remove(this._visibleSubLayerStates,this._visibleSubLayerStates[i]);break}}},t.prototype._onSubLayersChanged=function(t){for(var a,r=t.target.root,i=0;i<this._layerEventHandles.length;i++)if(this._layerEventHandles[i].layerId===r.id){a=this._layerEventHandles[i];break}if(null!=a){for(var i=0;i<t.added.length;i++){var n=this._addEventListenersToSubLayer(t.added[i]);a.subLayerEventHandles.push(n)}for(var i=0;i<t.removed.length;i++)for(var s=0;s<a.subLayerEventHandles.length;s++)if(a.subLayerEventHandles[s].layerId===t.removed[i].id.toString()){for(var l=0;l<a.subLayerEventHandles[s].eventHandles.length;l++)a.subLayerEventHandles[s].eventHandles[l].remove();e.core.utilities.ArrayHelper.remove(a.subLayerEventHandles,a.subLayerEventHandles[s]);break}var o=this._getSubLayerVisibilities(r);this._updateSubLayerVisibilityState(r.id,o.visibleSubLayerIds)}},t.prototype._onLayerVisibilityChange=function(e,t){var a=this._esriLayerToParsedLayerInfo(t);a.visible=e,gcxAnalyticsRelay.addDataToBeSent(a)},t.prototype._onSubLayerVisibilityChange=function(t,a){var r=a.parent,i=this._esriLayerToParsedLayerInfo(r),n=this._getSubLayerVisibilities(r),s=n.visibleSubLayerIds,l=this._getMatchingSubLayerVisibilityState(i.layerId);null!=l?(i.subLayerIdsVisibilityTurnedOn=e.core.utilities.ArrayHelper.except(s,l.visibleSubLayers),i.subLayerIdsVisibilityTurnedOff=e.core.utilities.ArrayHelper.except(l.visibleSubLayers,s)):i.subLayerIdsVisibilityTurnedOn=s,this._updateSubLayerVisibilityState(i.layerId,s),gcxAnalyticsRelay.addDataToBeSent(i)},t.prototype._onLayerErrorOccurred=function(e,t){var a=this._esriLayerToParsedLayerInfo(t);a.exceptionMessage=e.message,gcxAnalyticsRelay.addDataToBeSent(a)},t.prototype._onLayerLoadOccurred=function(e){var t=this._esriLayerToParsedLayerInfo(e);gcxAnalyticsRelay.addDataToBeSent(t)},t.prototype._esriLayerToParsedLayerInfo=function(a){for(var r=a.declaredClass.substring("esri.layers.".length),i=!1,n=0;n<t._validArcGisLayerTypes.length;n++)if(r===t._validArcGisLayerTypes[n]){i=!0;break}if(!1===i)return null;var s=new e.core.data.LayerState(a.id,r);s.layerName=a.title;var l=a.url;return null==l?null:(s.layerUrl=l,s.isLoaded=a.loaded,s)},t._validArcGisLayerTypes=["CSVLayer","ElevationLayer","FeatureLayer","ImageryLayer","IntegratedMeshLayer","MapImageLayer","SceneLayer","StreamLayer","TileLayer","VectorTileLayer"],t}();t.MapMonitor=a}(e.arcgis4xintegration||(e.arcgis4xintegration={}))}(e.analytics||(e.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var a=function(){function t(e){var t=this;this.portal=e,!0===e.loaded?this._startMonitoringPortal():this._portalLoadEventHandle=this.portal.watch("loaded",function(e,a,r,i){return t._startMonitoringPortal()})}return t.prototype.shutdown=function(){this._removeAllEventListeners()},t.prototype._startMonitoringPortal=function(){var t=this.portal.user;if(null!=t){var a=new e.analytics.core.data.PortalUser(t.username,t.email,t.fullName,this.portal.url);gcxAnalyticsRelay.addDataToBeSent(a),gcxAnalyticsRelay.forceSendPendingData()}},t.prototype._removeAllEventListeners=function(){null!=this._portalLoadEventHandle&&this._portalLoadEventHandle.remove()},t}();t.PortalMonitor=a}(t.arcgis4xintegration||(t.arcgis4xintegration={}))}(e.analytics||(e.analytics={}))}(geocortex||(geocortex={}));
var geocortex;!function(i){!function(n){!function(e){var t=function(){function e(){}return e.getAppType=function(i){if(null==i||"object"!=typeof i)return null;var n=null;if(null!=i.cfg&&(n=i.cfg.TPL_ID),null==n){var e=i.cfg;null==e&&"undefined"!=typeof APPCFG&&(e=APPCFG),null!=e&&null!=e.WEBAPP_KEYWORD_APP&&-1!==e.WEBAPP_KEYWORD_APP.indexOf("Story Map")&&(-1!==e.WEBAPP_KEYWORD_APP.indexOf("MapTour")?n=this.configurableAppTypes.mapTour:-1!==e.WEBAPP_KEYWORD_APP.indexOf("Cascade")?n=this.configurableAppTypes.cascade:-1!==e.WEBAPP_KEYWORD_APP.indexOf("MapSeries")?n=this.configurableAppTypes.mapSeries:-1!==e.WEBAPP_KEYWORD_APP.indexOf("MapJournal")?n=this.configurableAppTypes.mapJournal:-1!==e.WEBAPP_KEYWORD_APP.indexOf("Shortlist")?n=this.configurableAppTypes.shortlist:-1!==e.WEBAPP_KEYWORD_APP.indexOf("SwipeSpyglass")&&(n=this.configurableAppTypes.swipespyglass))}return null==n&&(null!=i._appViewManager?n=this.configurableAppTypes.boilerplate:null!=i.config&&(n=null!=i.currentMap?this.configurableAppTypes.mapCarousel:this.configurableAppTypes.basic)),n},e.initConfigForConfigurableApp=function(i,n,e,t){switch(t){case this.configurableAppTypes.mapSeries:case this.configurableAppTypes.mapJournal:case this.configurableAppTypes.cascade:case this.configurableAppTypes.shortlist:this.configurableAppTplReady(i,n,e,t);break;case this.configurableAppTypes.mapTour:this.configurableAppMapTour(i,n,e);break;case this.configurableAppTypes.swipespyglass:this.configurableAppSwipe(i,n,e);break;case this.configurableAppTypes.boilerplate:this.configurableAppBoilerplate(i,n,e);break;case this.configurableAppTypes.mapCarousel:this.configurableAppMapCarousel(i,n,e);break;case this.configurableAppTypes.basic:this.configurableAppBasic(i,n,e);break;default:console.log("Geocortex Analytics: Configurable App Type not supported.  Will revert to basic information gathering and attempt map and portal monitor fallback."),this._isTplCompatible(i)?this.configurableAppTplReady(i,n,e,t):this.configurableAppBasic(i,n,e)}},e.isConfigurableAppSettingsValid=function(i,e,t){return null!=i&&"object"==typeof i&&(!!n.AnalyticsConfig.isAppIdValid(e)&&!!n.AnalyticsConfig.isRelayUrlValid(t))},e.configurableAppBasic=function(i,e,t){var a=this;if(this.isConfigurableAppSettingsValid(i,e,t)&&!n.AnalyticsConfig.isInit()){n.AnalyticsConfig.config(e,t),this.configPortalForApp(i);var o=0,l=setInterval(function(){o++,a.configMapForBasicApp(i)?clearInterval(l):30===o&&(console.log("Geocortex Analytics: Map load timeout exceeded.  Unable to configure map."),clearInterval(l))},1e3)}},e.configurableAppMapCarousel=function(i,e,t){if(this.isConfigurableAppSettingsValid(i,e,t)&&!n.AnalyticsConfig.isInit()){n.AnalyticsConfig.config(e,t),this.configPortalForApp(i);var a=0,o=setInterval(function(){if(a++,null!=i.items){var e=i.items.length,t=0,l=setInterval(function(){for(var a=0;a<i.webmaps.length;a++)n.AnalyticsConfig.isMapAlreadyMonitored(i.webmaps[a])||(n.AnalyticsConfig.configMap(i.webmaps[a]),t++);t>=e&&clearInterval(l)},3e4);clearInterval(o)}else 30===a&&(console.log("Geocortex Analytics: Map load timeout exceeded.  Unable to configure map."),clearInterval(o))},1e3)}},e.configurableAppSwipe=function(i,e,t){if(this.isConfigurableAppSettingsValid(i,e,t)&&!n.AnalyticsConfig.isInit())return"undefined"==typeof require?void console.log("Geocortex Analytics: swipe/spyglass configurable app detected but require is undefined.  Unable to initialize"):void require(["dojo/topic"],function(a){a.subscribe("SWIPE_READY",function(){n.AnalyticsConfig.config(e,t),n.AnalyticsConfig.configMap(i.map),null!=i.portal&&n.AnalyticsConfig.configPortal(i.portal)})})},e.configurableAppMapTour=function(i,e,t){if(this.isConfigurableAppSettingsValid(i,e,t)&&!n.AnalyticsConfig.isInit())return"undefined"==typeof require?void console.log("Geocortex Analytics: map tour configurable app detected but require is undefined.  Unable to initialize"):void require(["dojo/topic"],function(a){a.subscribe("maptour-ready",function(){n.AnalyticsConfig.config(e,t),n.AnalyticsConfig.configMap(i.map),null!=i.portal&&n.AnalyticsConfig.configPortal(i.portal)})})},e.configurableAppTplReady=function(i,e,t,a){var o=this;if(this.isConfigurableAppSettingsValid(i,e,t)&&!n.AnalyticsConfig.isInit())return"undefined"==typeof require?void console.log("Geocortex Analytics: tpl-ready configurable app detected but require is undefined.  Unable to initialize"):void require(["dojo/topic"],function(l){l.subscribe("tpl-ready",function(){n.AnalyticsConfig.config(e,t),n.AnalyticsConfig.configPortal(i.portal),a===o.configurableAppTypes.shortlist&&n.AnalyticsConfig.configMap(i.map)}),l.subscribe("story-loaded-map",function(e){if(null!=e&&null!=i.maps){var t=i.maps[e.id];null!=t&&null!=t.response&&n.AnalyticsConfig.configMap(t.response.map)}})})},e.configurableAppBoilerplate=function(i,e,t){if(this.isConfigurableAppSettingsValid(i,e,t)&&!n.AnalyticsConfig.isInit()){n.AnalyticsConfig.config(e,t),null!=i._boilerplate&&n.AnalyticsConfig.configPortal(i._boilerplate.portal);var a=0,o=setInterval(function(){a++,null!=i._appViewManager.view?(n.AnalyticsConfig.configMap(i._appViewManager.view),clearInterval(o)):30===a&&(console.log("Geocortex Analytics: Map load timeout exceeded.  Unable to configure map."),clearInterval(o))},1e3)}},e.configMapForBasicApp=function(i){if(null==i)return!1;if(null!=i.map)return n.AnalyticsConfig.configMap(i.map),!0;if(null!=i.mapInfo&&0!==i.mapInfo.length){for(var e=0;e<i.mapInfo.length;e++)n.AnalyticsConfig.configMap(i.mapInfo[e].map);return!0}if(null!=i.scene)return n.AnalyticsConfig.configMap(i.scene),!0;if(null!=i.views&&0!==i.views.length){for(var e=0;e<i.views.length;e++)n.AnalyticsConfig.configMap(i.views[e]);return!0}return!1},e.configPortalForApp=function(e){if(null!=e){if(null!=e.config){if(null!=e.config.orgInfo&&null!=e.config.orgInfo.user)return void n.AnalyticsConfig.configPortal(e.config.orgInfo);if(null!=e.config.appResponse&&null!=e.config.appResponse.item&&null!=e.config.appResponse.item.access&&"public"!=e.config.appResponse.item.access.toLowerCase()&&"undefined"!=typeof esri&&void 0!==esri.arcgis&&void 0!==esri.arcgis.Portal){return void new esri.arcgis.Portal(e.config.sharinghost).signIn().then(function(n){i.analytics.arcgis3xintegration.PortalMonitor.recordPortalUser(n)})}}null!=e.portal&&n.AnalyticsConfig.configPortal(e.portal)}},e._isTplCompatible=function(i){return null!=i&&null!=i.cfg&&null!=i.cfg.TPL_ID},e.configurableAppTypes={mapTour:"maptour",swipespyglass:"swipespyglass",cascade:"storymap-cascade",shortlist:"shortlist",mapSeries:"mapseries",mapJournal:"mapjournal",boilerplate:"boilerplate",mapCarousel:"mapcarousel",basic:"basic"},e}();e.ConfigConfigurableApp=t}(n.config||(n.config={}))}(i.analytics||(i.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(i){!function(n){var e=function(){function e(){}return e.config=function(i,e,t){if(void 0===t&&(t=!1),!this.isAppIdValid(i))return void console.log("Geocortex Analytics: Invalid App Id.  Unable to initialize.");if(!this.isRelayUrlValid(e))return void console.log("Geocortex Analytics: Invalid Relay URL.  Unable to initialize.");if(this.isInit())return void console.log("Geocortex Analytics: Analytics API already initialized.");t&&n.core.storage.Cookie.disableStorage();var a=new n.core.data.Session;a.init();var o=new n.core.data.User;o.init(),gcxAnalyticsData={session:a,app:new n.core.data.App(i),user:o,mapMonitors:[],portalMonitors:[]},gcxAnalyticsRelay=new n.Relay(e)},e.configMap=function(i,n){var e=this;null!=i&&setTimeout(function(){if(!e.isInit())return void console.log("Geocortex Analytics: Cannot monitor map before Analytics API is initialized.");if("esri.views.MapView"===i.declaredClass||"esri.views.SceneView"===i.declaredClass)if(null!=i.map)e._monitorMap(i.map,i);else var t=i.watch("map",function(n){null!=n&&(e._monitorMap(n,i),t.remove())});else e._monitorMap(i,n)},0)},e.isMapAlreadyMonitored=function(i){if(null==i.id)return!1;for(var n=0;n<gcxAnalyticsData.mapMonitors.length;n++){if(gcxAnalyticsData.mapMonitors[n].map.id===i.id)return!0}return!1},e._monitorMap=function(n,e){if(this.isMapAlreadyMonitored(n))return void console.log("Geocortex Analytics: Map with ID '"+n.id+"' is already being monitored and cannot be added.");var t;t=void 0!==n.allLayers?new i.analytics.arcgis4xintegration.MapMonitor(n,e):new i.analytics.arcgis3xintegration.MapMonitor(n),gcxAnalyticsData.mapMonitors.push(t)},e.removeMap=function(i){var e=this;null!=i&&setTimeout(function(){if(e.isInit()){for(var t=0;t<gcxAnalyticsData.mapMonitors.length;t++){var a=gcxAnalyticsData.mapMonitors[t];if(a.map.id===i.id)return a.shutdown(),void n.core.utilities.ArrayHelper.remove(gcxAnalyticsData.mapMonitors,a)}console.log("Geocortex Analytics: Map with ID '"+i.id+"' is not being monitored and cannot be removed.")}},0)},e.configPortal=function(n){var e=this;null!=n&&setTimeout(function(){if(!e.isInit())return void console.log("Geocortex Analytics: Cannot monitor Portal instance before Analytics API is initialized.");if(null!=n.id)for(var t=0;t<gcxAnalyticsData.portalMonitors.length;t++){var a=gcxAnalyticsData.portalMonitors[t];if(a.portal.id===n.id&&a.portal.url===n.url)return void console.log("Geocortex Analytics: Portal with ID '"+n.id+"' is already being monitored and cannot be added.")}var o;if("esri.portal.Portal"===n.declaredClass)o=new i.analytics.arcgis4xintegration.PortalMonitor(n);else if("esri.arcgis.Portal"===n.declaredClass)o=new i.analytics.arcgis3xintegration.PortalMonitor(n);else{if("jimu.Portal"===n.declaredClass)return void(void 0!==n.getUser&&n.getUser().then(function(i){e.event.portalUserLogin({username:i.username,email:i.email,fullName:i.fullName,portalUrl:i.portalUrl})}));if(null!=n.user&&null!=n.user.username&&null!=n.user.email&&null!=n.user.fullName)return n.user.portal=n,void i.analytics.arcgis3xintegration.PortalMonitor.recordPortalUser(n.user)}null!=o&&gcxAnalyticsData.portalMonitors.push(o)},0)},e.removePortal=function(i){var e=this;null!=i&&setTimeout(function(){if(e.isInit()){for(var t=0;t<gcxAnalyticsData.portalMonitors.length;t++){var a=gcxAnalyticsData.portalMonitors[t];if(a.portal.id===i.id&&a.portal.url===i.url)return a.shutdown(),void n.core.utilities.ArrayHelper.remove(gcxAnalyticsData.portalMonitors,a)}console.log("Geocortex Analytics: Portal with ID '"+i.id+"' is not being monitored and cannot be removed.")}},0)},e.configConfigurableApp=function(i,e,t,a){return null==i||"object"!=typeof i?void console.log("Geocortex Analytics: app for configConfigurableApp missing.  Unable to initialize."):this.isAppIdValid(e)?this.isRelayUrlValid(t)?this.isInit()?void console.log("Geocortex Analytics: Analytics API already initialized."):void setTimeout(function(){null==a&&(a=n.config.ConfigConfigurableApp.getAppType(i)),n.config.ConfigConfigurableApp.initConfigForConfigurableApp(i,e,t,a)},0):void console.log("Geocortex Analytics: Invalid Relay URL.  Unable to initialize."):void console.log("Geocortex Analytics: Invalid App Id.  Unable to initialize.")},e.isInit=function(){return"undefined"!=typeof gcxAnalyticsRelay},e.isAppIdValid=function(i){return null!=i&&0!=+i},e.isRelayUrlValid=function(i){return null!=i&&0!=+i},e.event=n.core.appevents.AppEvent,e}();n.AnalyticsConfig=e,"undefined"==typeof window&&(gcxAnalyticsObject=n),gcxAnalytics=e}(i.analytics||(i.analytics={}))}(geocortex||(geocortex={}));var geocortex;!function(i){!function(i){var n=function(){function n(i){var n=this;i.length>=1e3&&console.log("Geocortex Analytics: Relay URL is very long.  Requests may fail as they may exceed maximum URL length allowable"),this._relayUrl=i,this._pendingData=[],setTimeout(function(){return n._sendInitData()},100),setInterval(function(){return n._sendPendingData(!0)},3e5)}return n.prototype.addDataToBeSent=function(i){var n=this;gcxAnalyticsData.session.incrementSessionDuration(),this._pendingData.push(i),null==this._pendingDataToken&&(this._pendingDataToken=window.setTimeout(function(){return n._sendPendingData()},3e4))},n.prototype.forceSendPendingData=function(){var i=this;setTimeout(function(){i._sendPendingData()},100)},n.prototype._sendPendingData=function(i){void 0===i&&(i=!1),(i||0!==this._pendingData.length)&&(this._sendData.apply(this,this._pendingData),this._pendingData=[],this._pendingDataToken=null)},n.prototype._sendInitData=function(){var n=new i.core.data.Browser;n.init(),this._pendingData.unshift(n),this._sendPendingData()},n.prototype._sendData=function(){for(var i=[],e=0;e<arguments.length;e++)i[e-0]=arguments[e];for(var t=[gcxAnalyticsData.app.toQueryString(),gcxAnalyticsData.session.toQueryString(),gcxAnalyticsData.user.toQueryString()].join("&"),a=[t],o=this._relayUrl.length+n.cacheBuster.length+(new Date).getTime().toString().length+t.length+3,l=o,r=0,s=i.length;r<s;r++){var c=i[r].toQueryString();l+c.length+1>2083?(this._sendSanitizedDataStrings.apply(this,a),a=[t,c],l=o+c.length+1):(l+=c.length+1,a.push(c))}0!==a.length&&this._sendSanitizedDataStrings.apply(this,a)},n.prototype._sendSanitizedDataStrings=function(){for(var i=[],e=0;e<arguments.length;e++)i[e-0]=arguments[e];var t=i.join("&");document.createElement("img").src=this._relayUrl+"?"+t+"&"+n.cacheBuster+"="+(new Date).getTime()},n.cacheBuster="x",n}();i.Relay=n}(i.analytics||(i.analytics={}))}(geocortex||(geocortex={}));